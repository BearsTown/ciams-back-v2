<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.uitgis.ciams.user.mapper.CiamsCodeMapper">
    <sql id="default_column">
        code, code_name, sort_sn, parent_code, code_val, code_desc, use_yn
    </sql>


    <select id="selectCodeListByParentCode" parameterType="string"
            resultType="com.uitgis.ciams.user.dto.CiamsCodeDto$Find">
        SELECT<include refid="default_column"/>, (SELECT NOT EXISTS (SELECT code FROM CIAMS_CODE b WHERE b.parent_code =
        cod.code) _a ) AS leaf
        FROM CIAMS_CODE cod
        WHERE 1=1
        <if test="@com.uitgis.ciams.util.ValidUtil@empty(parentCode)">
            AND cod.PARENT_CODE IS nuUll
        </if>
        <if test="@com.uitgis.ciams.util.ValidUtil@notEmpty(parentCode)">
            AND cod.PARENT_CODE = #{parentCode}
        </if>
        ORDER BY cod.SORT_SN, cod.CODE
    </select>


    <select id="selectCodeByCode" parameterType="string" resultType="com.uitgis.ciams.user.dto.CiamsCodeDto$Find">
        SELECT<include refid="default_column"/>, (SELECT NOT EXISTS (SELECT code FROM CIAMS_CODE b WHERE b.parent_code =
        cod.code) _a ) AS leaf
        FROM CIAMS_CODE cod
        WHERE 1=1
        AND CODE = #{code}
    </select>


    <select id="selectCodeSublist" parameterType="map" resultType="com.uitgis.ciams.model.CiamsCode">
        WITH RECURSIVE dept_record(code, parent_code, code_name, code_val, code_desc, use_yn, level, path, cycle)
        AS (SELECT d.code, d.parent_code, d.code_name, d.code_val, d.code_desc, d.use_yn, 0, array[d.code]::varchar[],
        false
        FROM ciams_code d
        WHERE d.parent_code IS NULL
        <if test="@com.uitgis.ciams.util.ValidUtil@notEmpty(code)">
            and code = #{code}
        </if>

        UNION ALL

        SELECT d.code, d.parent_code, d.code_name, d.code_val, d.code_desc, d.use_yn, level + 1, path || d.code, d.code
        = ANY (path)
        FROM ciams_code d,
        dept_record dr
        WHERE d.parent_code = dr.code
        <if test="@com.uitgis.ciams.util.ValidUtil@notEmpty(useYn)">
            AND d.use_yn = #{useYn}
        </if>
        AND NULLIF(trim(d.code_name),'') IS NOT NULL
        AND NOT CYCLE)
        SELECT code, parent_code, code_name, code_val, code_desc, use_yn
        FROM dept_record
        <trim prefix="WHERE" prefixOverrides="AND |OR ">
            <if test="!useRoot">
                AND level > 0
            </if>
        </trim>
        ORDER BY path
    </select>

</mapper>
